var App=function(){{var t=this;$(window).height()-200,$(window).width()}$(window).on("scroll",function(){var e=$(window).scrollTop();if(console.log("scrollTop",e),t.map&&(3700>e&&(t.fullMap&&t.fullMap!==!1||(t.na=!1,t.eu=!1,t.af=!1,t.zoomToFullExtent())),e>=3700&&5300>e&&(t.na&&t.na!==!1||(t.na=!0,t.eu=!1,t.af=!1,t.northAmerica())),e>=5300&&7700>e&&(t.eu&&t.eu!==!1||(t.eu=!0,t.na=!1,t.af=!1,t.europe())),e>=7700&&(t.af&&t.af!==!1||(t.af=!0,t.na=!1,t.eu=!1,t.africa()))),e>3900){var a=e-3900;a>=1011&&(a=1011),$("#dc-dataset-count").html("Datasets Shared: "+a)}if(e>4900){var r=e-4900;r>=42&&(r=42),$("#charlotte-dataset-count").html("Datasets Shared: "+r)}if(e>5880){var n=e-5880;n>=356&&(n=356),$("#md-dataset-count").html("Datasets Shared: "+n)}}),this.countryStats={},this.initMap(),this.orgChart(),this.monthlyChart()};App.prototype.zoomToFullExtent=function(){var t=new esri.geometry.Extent(-173.11931249996786,-19.387313471278183,61.0213124999697,71.27489360077264,new esri.SpatialReference({wkid:4326}));this.map.setExtent(t)},App.prototype.northAmerica=function(){console.log("set north america!");var t=new esri.geometry.Extent(-152,10,-35,58,new esri.SpatialReference({wkid:4326}));this.map.setExtent(t,function(){console.log("on COMPLETEL111 -----------")}),this.generateStats("north-america")},App.prototype.europe=function(){console.log("set europe!");var t=new esri.geometry.Extent(-51,27,65,66,new esri.SpatialReference({wkid:4326}));this.map.setExtent(t),this.generateStats("europe")},App.prototype.africa=function(){console.log("set europe!");var t=new esri.geometry.Extent(-48,-25,69,32,new esri.SpatialReference({wkid:4326}));this.map.setExtent(t),this.generateStats("africa")},App.prototype.generateStats=function(t){if(this.countryStats[t])$("."+t+"#org-count").html("Total Orgs: "+this.countryStats[t].visible.length.toLocaleString()),$("."+t+"#dataset-count").html("Datasets Shared: "+this.countryStats[t].datasets.toLocaleString());else{var e=this.map.getLayer("circles").graphics,a=[],r=0;_.each(e,function(t){self.map.extent.contains(t.geometry)===!0&&(r+=t.attributes.datasets,a.push(t))}),$("."+t+"#org-count").html("Total Orgs: "+a.length.toLocaleString()),$("."+t+"#dataset-count").html("Datasets Shared: "+r.toLocaleString()),console.log("Total orgs: ",a.length),console.log("Total Datasets: ",r),this.countryStats[t]={},this.countryStats[t].visible=a,this.countryStats[t].datasets=r}},App.prototype.initMap=function(){var t=this;require(["esri/map","dojo/request","esri/geometry/Circle","esri/symbols/SimpleFillSymbol","esri/graphic","esri/layers/GraphicsLayer","esri/geometry/Point","esri/SpatialReference","esri/geometry/webMercatorUtils","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/FeatureLayer","dojo/domReady!"],function(e,a,r,n,o,i,s,l,c){function p(t){var e={geometry:{x:t.geometry.x,y:t.geometry.y,spatialReference:{wkid:102100}},attributes:{title:t.attributes.title,datasets:t.attributes.datasets_count,url:t.attributes.url,groups:t.attributes.groups_count},symbol:{color:[241,196,15,128],size:Math.min(Math.round(t.attributes.datasets_count/100*40),50),angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[230,126,34,200],width:1,type:"esriSLS",style:"esriSLSSolid"}}},a=new o(e);f.add(a)}function d(t){var e=t.graphic.attributes.datasets,a=t.graphic.attributes.title,r=t.graphic.attributes.groups;$("#title").html(a),$("#groups").html("Open Data Groups: "+r),$("#count").html("Datasets: "+e)}function u(t){""!==t.graphic.attributes.url&&null!==t.graphic.attributes.url&&window.open(t.graphic.attributes.url)}esriConfig.defaults.map.basemaps.dotted={baseMapLayers:[{url:"http://studio.esri.com/arcgis/rest/services/World/WorldBasemapWhite/MapServer"}],title:"dots"},t.map=new e("map-locations",{center:[-56.049,38.485],zoom:3,basemap:"dotted",smartNavigation:!1}),t.map.on("load",function(){t.map.disableScrollWheelZoom(),$("#loader-main").fadeOut("slow",function(){$("#scroll-help").addClass("bounceIn"),setTimeout(function(){$("#scroll-help").removeClass("bounceIn"),$("#scroll-help").addClass("pulse")},2e3)})});var f=new i({id:"circles"});t.map.addLayer(f),t.map.on("click",function(){}),window.map=t.map,f.on("mouse-over",function(t){d(t)}),f.on("click",function(t){u(t)}),f.on("mouse-out",function(){}),a("data/explore.json").then(function(e){var a,r=JSON.parse(e).sites;r.forEach(function(t){var e,r=t.default_extent.xmin+(t.default_extent.xmax-t.default_extent.xmin)/2,n=t.default_extent.ymin+(t.default_extent.ymax-t.default_extent.ymin)/2;if(t.default_extent.spatialReference)if(4326===t.default_extent.spatialReference.wkid){var o=c.lngLatToXY(r,n);e={x:o[0],y:o[1],type:"point",spatialReference:{latestWkid:3857,wkid:102100}}}else e={x:r,y:n,type:"point",spatialReference:{latestWkid:3857,wkid:102100}};else if(4326===t.default_extent.spatial_reference.wkid){var o=c.lngLatToXY(r,n);e={x:o[0],y:o[1],type:"point",spatialReference:{latestWkid:3857,wkid:102100}}}else e={x:r,y:n,type:"point",spatialReference:{latestWkid:3857,wkid:102100}};a={geometry:e,attributes:{title:t.title,url:t.url,created_at:t.created_at,updated_at:t.updated_at,"public":t.public,groups_count:t.groups_count,datasets_count:t.datasets_count}},p(a)});var n=[];_.each(r,function(t){s=new esri.geometry.Extent(t.default_extent.xmin,t.default_extent.ymin,t.default_extent.xmax,t.default_extent.ymax,new esri.SpatialReference({wkid:102100})),n.push(s)});var o=n,i=new esri.layers.GraphicsLayer({id:"extentLayer"});t.map.addLayer(i);for(var s,l,d=[],u=esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,255,255]),.4),new dojo.Color([93,173,221,0])),f=0;f<r.length;f++)102100===r[f].default_extent.spatial_reference.wkid?(l=new esri.Graphic(o[f],u,{name:r[f].title,url:r[f].url}),d.push(l),i.add(l)):console.log("no")})})},App.prototype.orgChart=function(){function t(t){return t.frequency=+t.frequency,t}var e={top:20,right:40,bottom:30,left:60},a=$(window).width()-e.left-e.right,r=$(window).height()/2-e.top-e.bottom,n=d3.scale.ordinal().rangeRoundBands([0,a],.1),o=d3.scale.linear().range([r,0]),i=d3.svg.axis().scale(n).orient("bottom"),s=d3.svg.axis().scale(o).orient("left").ticks(5),l=d3.select("#org-chart").append("svg").attr("width",a+e.left+e.right).attr("height",r+e.top+e.bottom).append("g").attr("transform","translate("+e.left+","+e.top+")");d3.tsv("data/org.tsv",t,function(t,e){n.domain(e.map(function(t){return t.letter})),o.domain([0,d3.max(e,function(t){return t.frequency})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(i),l.append("g").attr("class","y axis").call(s).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Count"),l.selectAll(".bar").data(e).enter().append("rect").attr("class","bar").attr("x",function(t){return n(t.letter)}).attr("width",n.rangeBand()).attr("y",function(t){return o(t.frequency)}).attr("height",function(t){return r-o(t.frequency)})})},App.prototype.monthlyChart=function(){var t={top:20,right:80,bottom:30,left:90},e=$(window).width()-t.left-t.right,a=$(window).height()/2-t.top-t.bottom,r=d3.time.format("%d-%b-%y").parse,n=d3.time.scale().range([0,e]),o=d3.scale.linear().range([a,0]),i=d3.svg.axis().scale(n).orient("bottom"),s=d3.svg.axis().scale(o).orient("left"),l=d3.svg.line().x(function(t){return n(t.date)}).y(function(t){return o(t.close)}),c=d3.select("#monthly-chart").append("svg").attr("width",e+t.left+t.right).attr("height",a+t.top+t.bottom).append("g").attr("transform","translate("+t.left+","+t.top+")");d3.tsv("data/line-data.tsv",function(t,e){e.forEach(function(t){t.date=r(t.date),t.close=+t.close}),n.domain(d3.extent(e,function(t){return t.date})),o.domain(d3.extent(e,function(t){return t.close})),c.append("g").attr("class","x axis").attr("transform","translate(0,"+a+")").call(i),c.append("g").attr("class","y axis").call(s).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Shared Datasets"),c.append("path").datum(e).attr("class","line").attr("d",l)})};